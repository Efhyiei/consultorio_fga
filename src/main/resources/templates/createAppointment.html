<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Patient Registration</title>
    <!-- Bootstrap CSS link -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <!-- Add these links to your existing <head> section -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/css/bootstrap-datepicker.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/js/bootstrap-datepicker.min.js"></script>

</head>
<body>

<div class="container mt-5">
    <h2>Patient Registration</h2>

    <form id="patientRegistrationForm">
        <!-- Patient Name -->
        <div class="form-group">
            <label for="patientName">Patient Name:</label>
            <input type="text" class="form-control" id="patientName" name="patientName">
        </div>

        <!-- Patient Email -->
        <div class="form-group">
            <label for="patientEmail">Patient Email:</label>
            <input type="email" class="form-control" id="patientEmail" name="patientEmail">
        </div>

        <!-- Doctor Selection -->
        <div class="form-group">
            <label for="doctorSelect">Select Doctor:</label>
            <select class="form-control" id="doctorSelect" name="doctorId">
                <!-- Doctors will be populated dynamically from REST endpoint -->
            </select>
        </div>

        <!-- Date Selection -->
        <div class="form-group">
            <label for="appointmentDate">Select Appointment Date:</label>
            <input type="text" class="form-control" id="appointmentDate" name="appointmentDate" required>
        </div>

        <!-- Doctor schedule display area -->
        <div id="scheduleDisplay" class="form-group">
            <!-- The schedule will be displayed here -->
        </div>


        <input type="hidden" id="appointmentHour" name="appointmentHour" required>
        <!-- Submit Button -->
        <button type="submit" class="btn btn-primary">Register</button>
        <button th:href="@{/api/v1/consulting/view/schedules/report}" type="submit" class="btn btn-black">Go to doctor's schedules</button>
    </form>
</div>

<!-- jQuery -->
<script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
<!-- Bootstrap JS dependencies -->
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.10.2/dist/umd/popper.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
<!-- Bootstrap Datepicker JS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/js/bootstrap-datepicker.min.js"></script>


<!-- Your custom script to fetch and populate doctors in the dropdown -->
<script>
    var selectedDoctorId = 1;
    // Fetch and populate doctors in the dropdown
    $(document).ready(function () {
        $.ajax({
            url: '/api/v1/consulting/doctors/findAll',
            method: 'GET',
            dataType: 'json',
            success: function (response) {
                if (response.doctors && Array.isArray(response.doctors)) {
                    var doctors = response.doctors;
                    var doctorSelect = $('#doctorSelect');
                    doctors.forEach(function (doctor) {
                        var option = $('<option>').val(doctor.id).text(doctor.fullName);
                        doctorSelect.append(option);
                    });

                    // Set the selectedDoctorId when the doctor is selected
                    doctorSelect.change(function () {
                        selectedDoctorId = doctorSelect.val();
                    });
                } else {
                    console.error('Invalid response format. Expected an array of doctors.');
                }
            },
            error: function (error) {
                console.error('Error fetching doctors:', error);
            }
        });
    });

    // Your custom validation or submission logic here
    $('#patientRegistrationForm').submit(function (event) {
        // Prevent the form from submitting normally
        event.preventDefault();

        // Your custom logic to handle form submission
        // Get the selected doctor ID, appointment date, patient email, and appointment hour
        var doctorId = $('#doctorSelect').val();
        var selectedDate = $('#appointmentDate').val();
        var patientEmail = $('#patientEmail').val();
        var patientName = $('#patientName').val();
        var appointmentHour = $('#appointmentHour').val();

        // Prepare the data for the POST request
        var requestData = {
            doctorId: doctorId,
            appointmentDate: selectedDate,
            patientEmail: patientEmail,
            patientName: patientName,
            appointmentHour: appointmentHour
        };

        // Make the POST request
        $.ajax({
            url: '/api/v1/consulting/appointments/create',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(requestData),
            success: function (response) {
                // Handle success response as needed
                alert('Appointment created successfully!');
            },
            error: function (error) {
                console.error('Error creating appointment:', error);
            }
        });
    });

    // Initialize datepicker
        $('#appointmentDate').datepicker({
            format: 'yyyy-mm-dd',
            autoclose: true
        });

    // Use the changeDate event to trigger the AJAX request
        $('#appointmentDate').on('changeDate', function (e) {
            // Check if both doctor and date are selected
            if (selectedDoctorId && e.format()) {
                // Make an AJAX request when a date is selected
                var requestData = {
                    doctorId: selectedDoctorId,
                    date: e.format('yyyy-mm-dd')
                };

                $.ajax({
                    url: '/api/v1/consulting/doctors/schedule/getAvailableAppointments',
                    method: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify(requestData),
                    success: function (response) {
                        // Check if the response has the "appointments" property and it's an array
                        if (response.appointments && Array.isArray(response.appointments)) {
                            var scheduleDisplay = $("#scheduleDisplay");
                            scheduleDisplay.html("<p>Doctor Schedule:</p>");

                            response.appointments.forEach(function (hour) {
                            var button = $("<button>")
                                .addClass("btn btn-primary")
                                .text(hour)
                                .on("click", function (event) {
                                    // Prevent form submission on button click
                                    event.preventDefault();

                                    // Handle button click, store selected hour in appointmentHour
                                    var selectedHour = $(this).text();
                                    $("#appointmentHour").val(selectedHour);
                                    // alert("Selected appointment hour: " + selectedHour);
                                });

                            scheduleDisplay.append(button);
                            });
                        } else {
                            // Handle invalid response format
                            $("#scheduleDisplay").html("<p>Error: Invalid response format</p>");
                            console.error('Invalid response format. Expected an array under "appointments".');
                        }
                    },
                    error: function (error) {
                        console.error('Error fetching doctor schedule:', error);
                    }
                });
            }
        });
</script>

</body>
</html>
